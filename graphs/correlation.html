<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Graph: Understanding the Correlation Coefficient</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/shinylive@0.2.3/dist/shinylive.js"></script>

    <!-- Google Analytics Tag -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YEPLTYLL6H"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YEPLTYLL6H');
</script>
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .shinylive-container {
            margin: 20px auto;
            max-width: 1200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .loading-container {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea3a44;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-container {
            max-width: 400px;
            margin: 20px auto;
        }
        .progress-bar {
            background-color: #ea3a44;
            transition: width 0.3s ease;
        }
        .loading-steps {
            text-align: left;
            max-width: 500px;
            margin: 20px auto;
            font-size: 14px;
        }
        .step {
            padding: 5px 0;
            opacity: 0.5;
        }
        .step.active {
            opacity: 1;
            color: #ea3a44;
            font-weight: bold;
        }
        .step.completed {
            opacity: 0.7;
            color: #28a745;
        }
        .step::before {
            content: "‚è≥ ";
        }
        .step.active::before {
            content: "üîÑ ";
        }
        .step.completed::before {
            content: "‚úÖ ";
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="shinylive-container">
            <div class="loading-container" id="loading-container">
                <h4>Loading Interactive Correlation Coefficient App</h4>
                <div class="loading-spinner"></div>
                
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="progress-text">Initializing...</small>
                    </div>
                </div>
                
                <div class="loading-steps">
                    <div class="step active" id="step-1">Downloading R WebAssembly runtime</div>
                    <div class="step" id="step-2">Loading R packages</div>
                    <div class="step" id="step-3">Initializing Shiny environment</div>
                    <div class="step" id="step-4">Preparing interactive interface</div>
                    <div class="step" id="step-5">Ready to explore correlations!</div>
                </div>
            </div>
            <div id="shinylive-container"></div>
        </div>
    </div>

    <script type="module">
        import { runApp } from "https://cdn.jsdelivr.net/npm/shinylive@0.2.3/dist/shinylive.js";

        // Analytics tracking functions
        function trackEvent(eventName, parameters = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
        }

        function trackPageView(pagePath) {
            if (typeof gtag !== 'undefined') {
                gtag('config', 'GA_MEASUREMENT_ID', {
                    page_path: pagePath
                });
            }
        }

        // Progress tracking
        let currentStep = 1;
        const totalSteps = 5;
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        function updateProgress(step, message) {
            // Update previous step as completed
            if (currentStep > 1) {
                const prevStep = document.getElementById(`step-${currentStep - 1}`);
                if (prevStep) {
                    prevStep.classList.remove('active');
                    prevStep.classList.add('completed');
                }
            }

            // Update current step
            currentStep = step;
            const currentStepEl = document.getElementById(`step-${currentStep}`);
            if (currentStepEl) {
                currentStepEl.classList.add('active');
            }

            // Update progress bar
            const progress = (step / totalSteps) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = message;

            // Track progress in analytics
            trackEvent('app_loading_progress', {
                step: step,
                total_steps: totalSteps,
                progress_percent: Math.round(progress)
            });
        }

        // Simulate loading steps with realistic timing
        function simulateLoadingSteps() {
            const steps = [
                { step: 1, message: 'Downloading R WebAssembly runtime...', delay: 1000 },
                { step: 2, message: 'Loading R packages...', delay: 2000 },
                { step: 3, message: 'Initializing Shiny environment...', delay: 3000 },
                { step: 4, message: 'Preparing interactive interface...', delay: 4000 },
                { step: 5, message: 'Almost ready...', delay: 5000 }
            ];

            steps.forEach(({ step, message, delay }) => {
                setTimeout(() => {
                    updateProgress(step, message);
                }, delay);
            });
        }

        // Track page load
        trackPageView('/correlation-app');
        trackEvent('app_load_started');

        // Start loading simulation
        simulateLoadingSteps();

        const appFiles = {
            "app.R": `library(shiny)

## Define UI
ui = fluidPage(

  tags$head(
    tags$style(HTML("
      .well {
        background-color: #f1f3f5 !important;
        border: none;
        box-shadow: none;
      }
    "))
  ),

  ## App Title
  h3("Interactive Graph: Understanding the Correlation Coefficient",
     style = "color: #ea3a44; text-align: center; margin-bottom: 0px;"),
  p("By Elena Llaudet, co-author of ",
    a("Data Analysis for Social Science", href = "https://bit.ly/dss_textbook", target = "_blank", style = "color: #797979; text-decoration: none; font-style: italic;"),
    " (DSS)", style = "text-align: center; color: #797979; margin-bottom: 15px; font-size: 18px;"),

  ## Framed Text with Key Points
  div(style = "background-color: #f1f3f5;
            border-left: 4px solid #ea3a44;
            padding: 15px;
            margin-bottom: 15px;",
      p("The correlation coefficient (or correlation)
      captures the direction and strength of the linear association between two variables
      with a number that ranges from -1 to 1.",
        style = "margin: 0 0 10px 0; font-size: 16px; color: #333333;"),
      HTML("
      <ul style='margin: 0; padding-left: 20px; line-height: 1.4;'>
        <li style='margin-bottom: 8px; font-size: 16px; color: #333333;'>
          The sign reflects the direction: positive when the variables tend to move together (when the slope of the line of best fit
          is positive) and negative when the variables tend to move in opposite directions (when the slope of the line of best fit is negative).
        </li>
        <li style='margin-bottom: 0; font-size: 16px; color: #333333;'>
          The absolute value reflects the strength: it ranges from 0 (no linear association)
          to 1 (perfect linear association), increasing as dots get closer to the line of best fit.
        </li>
      </ul>
    ")),

  ## Explanation
  helpText("Let's explore how changing the direction and strength of the linear association affects the correlation coefficient:",
           style = "font-size: 16px; color: #333333; margin-bottom: 15px"),

  ## Steps
  helpText(HTML("
    <ul style='line-height: 1.4;'>
      <li style='margin-bottom: 10px;'><b style='color: #ea3a44;'>STEP 1:</b>
          The graph below shows a scatterplot with a correlation of 1.
          The sign is positive because the slope of the line of best fit is positive (moves upwards from left to right),
          and the absolute value is 1 because all dots are exactly on the line.
          (Check the box below to show the line of best fit as a dashed red line.)
      </li>

      <li style='margin-bottom: 10px;'><b style='color: #ea3a44;'>STEP 2:</b>
          Use the first drop-down menu to change the direction of the linear association.
          Notice that when the association goes from positive to negative,
          the line of best fit changes from sloping upwards to sloping downwards (from left to right) and
          the correlation coefficient goes from having a positive sign to having a negative sign.
      </li>

      <li style='margin-bottom: 10px;'><b style='color: #ea3a44;'>STEP 3:</b>
          Use the second drop-down menu to change the strength of the linear association.
          Weaker associations move dots farther from the line, decreasing the absolute value of the correlation.
          Stronger associations move dots closer to the line, increasing the absolute value of the correlation.
      </li>
    </ul>
  "), style = "font-size: 16px; color: #333333; margin-bottom: 20px"),

  ## Sidebar Layout with Inputs and Outputs
  sidebarLayout(

    ## Sidebar Panel for Inputs
    sidebarPanel(

      ## Direction
      HTML("<span style='color: #333333; font-size: 15px; display: inline-block; margin-bottom: 2px;'>Direction of Linear Association:</span>"),
      p("Select whether the variables tend to move in the same direction (positive) or in opposite directions (negative) and observe how that changes the slope of the line of best fit and the sign of the correlation coefficient.",
        style = "font-size: 14px; color: #666; text-align: left; margin-top: 0px; margin-bottom: 10px;"),

      selectInput(
        inputId = "sign",
        label = NULL,
        choices = c("positive linear association", "negative linear association")
      ),

      ## Strength
      HTML("<span style='color: #333333; font-size: 15px; display: inline-block; margin-bottom: 2px;'>Strength of Linear Association:</span>"),
      p("Select the strength of the linear association and observe how that changes how tightly the dots cluster around the line of best fit and the absolute value of the correlation coefficient.",
        style = "font-size: 14px; color: #666; text-align: left; margin-top: 0px; margin-bottom: 10px;"),

      selectInput(
        inputId = "strength",
        label = NULL,
        choices = c(
          "perfect linear association",
          "strong linear association",
          "weak to moderate linear association",
          "no linear association (approximately)"
        )
      ),

      ## Checkbox
      checkboxInput("line", "Show Line of Best Fit", FALSE)

    ),

    ## Main Panel for Displaying Outputs
    mainPanel(

      ## Output: Graph
      plotOutput(outputId = "distPlot", height = "400px"),

      ## Text After Graph
      helpText(HTML("Notes: A scatterplot enables us to visualize the relationship between two variables by
              plotting one variable against the other in two-dimensional space. Each dot represents an observation.
              The line of best fit is the line that best summarizes the data cloud.
              For illustration purposes, here we use <em>weak</em>, <em>moderate</em>, and <em>strong</em>,
              but note that what is considered a <em>weak</em> correlation in one field may be considered <em>strong</em> in another."),
               style = "font-size: 15px; color: #666; margin-top: 0px;")
    )
  ),
)

## Define Server Logic Required to Draw the Graph
server = function(input, output) {

  # Pre-generate base data once
  set.seed(1234)
  base_x <- rnorm(1000, mean = 50, sd = 10)

  # Create reactive values for computed data
  computed_data <- reactive({
    # Get sign multiplier
    sign_mult <- switch(input$sign,
                        "positive linear association" = 1,
                        "negative linear association" = -1)

    # Generate y values based on strength
    y_values <- switch(input$strength,
                       "no linear association (approximately)" = rnorm(1000, mean = 50, sd = 20),
                       "weak to moderate linear association" = base_x + rnorm(1000, mean = 50, sd = 16),
                       "strong linear association" = base_x + rnorm(1000, mean = 50, sd = 7),
                       "perfect linear association" = base_x)

    # Apply sign
    y_final <- sign_mult * y_values

    # Calculate correlation
    correlation <- cor(base_x, y_final)

    list(
      x = base_x,
      y = y_final,
      correlation = correlation
    )
  })

  ## Graph
  output$distPlot <- renderPlot({
    # Get computed data
    data <- computed_data()

    # Set up plot parameters once
    par(mfrow = c(1, 1), cex = 1.2, mar = c(1, 1, 3.5, 1))

    # Create the plot
    plot(data$x, data$y,
         col = "#1f78b4",
         ylab = "",
         xlab = "",
         cex = .6,
         xaxt = "n",
         yaxt = "n",
         yaxs = "r",
         xaxs = "r",
         axes = TRUE,
         col.lab = "#333333",
         bty = "n",
         pch = 19,
         col.main = "#333333",
         col.axis = "#333333")

    # Add regression line if requested
    if (input$line == TRUE) {
      abline(lm(data$y ~ data$x), col = "#ea3a44", lty = "dashed", lwd = 2)
    }

    # Add box and text
    box(col="gray17")
    mtext(paste("Correlation =", round(data$correlation, 2)),
          side = 3, line = .5, cex = 1.1, col = "#333333")
    mtext("Scatterplot", side=3, line = 1.5, cex=1.3, font=2)

  }, bg = "white")
}

## Create Shiny App
shinyApp(ui = ui, server = server)`
        };

        // Initialize the app
        const startTime = Date.now();
        
        runApp(appFiles, "shinylive-container", {
            width: "100%",
            height: "800px"
        }).then(() => {
            // Calculate load time
            const loadTime = Date.now() - startTime;
            
            // Complete final step
            updateProgress(5, 'Ready to explore correlations!');
            
            // Hide loading container after a short delay
            setTimeout(() => {
                document.getElementById('loading-container').style.display = 'none';
                
                // Track successful load
                trackEvent('app_load_completed', {
                    load_time_ms: loadTime,
                    load_time_seconds: Math.round(loadTime / 1000)
                });
                
                // Add event listeners for user interactions
                addInteractionTracking();
                
            }, 1000);
        }).catch((error) => {
            // Track loading error
            trackEvent('app_load_error', {
                error_message: error.message,
                load_time_ms: Date.now() - startTime
            });
            
            // Show error message
            document.getElementById('loading-container').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Loading Error</h4>
                    <p>There was an error loading the app. Please try refreshing the page.</p>
                    <hr>
                    <p class="mb-0">Error: ${error.message}</p>
                </div>
            `;
        });

        // Function to add interaction tracking once app is loaded
        function addInteractionTracking() {
            // Track when users interact with the app
            document.addEventListener('change', function(e) {
                if (e.target.id === 'sign' || e.target.id === 'strength') {
                    trackEvent('user_interaction', {
                        interaction_type: 'dropdown_change',
                        element_id: e.target.id,
                        selected_value: e.target.value
                    });
                } else if (e.target.id === 'line') {
                    trackEvent('user_interaction', {
                        interaction_type: 'checkbox_toggle',
                        element_id: e.target.id,
                        checked: e.target.checked
                    });
                }
            });

            // Track session duration
            let sessionStart = Date.now();
            window.addEventListener('beforeunload', function() {
                const sessionDuration = Date.now() - sessionStart;
                trackEvent('session_end', {
                    session_duration_ms: sessionDuration,
                    session_duration_minutes: Math.round(sessionDuration / 60000)
                });
            });
        }
    </script>
</body>
</html>
