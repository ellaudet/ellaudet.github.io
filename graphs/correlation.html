<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Graph: Understanding the Correlation Coefficient</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<!-- Google Analytics Tag -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YEPLTYLL6H"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-YEPLTYLL6H');
</script>
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .shinylive-container {
            margin: 20px auto;
            max-width: 1200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .loading-container {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea3a44;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-container {
            max-width: 400px;
            margin: 20px auto;
        }
        .progress-bar {
            background-color: #ea3a44;
            transition: width 0.3s ease;
        }
        .loading-steps {
            text-align: left;
            max-width: 500px;
            margin: 20px auto;
            font-size: 14px;
        }
        .step {
            padding: 5px 0;
            opacity: 0.5;
        }
        .step.active {
            opacity: 1;
            color: #ea3a44;
            font-weight: bold;
        }
        .step.completed {
            opacity: 0.7;
            color: #28a745;
        }
        .step::before {
            content: "‚è≥ ";
        }
        .step.active::before {
            content: "üîÑ ";
        }
        .step.completed::before {
            content: "‚úÖ ";
        }
        .error-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        .timeout-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 20px auto;
            max-width: 500px;
        }
        .fallback-app {
            display: none;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="shinylive-container">
            <!-- Loading Container -->
            <div class="loading-container" id="loading-container">
                <h4>Loading Interactive Correlation Coefficient App</h4>
                <div class="loading-spinner"></div>
                
                <div class="progress-container">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="progress-text">Initializing...</small>
                    </div>
                </div>
                
                <div class="loading-steps">
                    <div class="step active" id="step-1">Downloading R WebAssembly runtime (~50MB)</div>
                    <div class="step" id="step-2">Loading R packages</div>
                    <div class="step" id="step-3">Initializing Shiny environment</div>
                    <div class="step" id="step-4">Preparing interactive interface</div>
                    <div class="step" id="step-5">Ready to explore correlations!</div>
                </div>

                <!-- Timeout Warning -->
                <div class="timeout-warning" id="timeout-warning" style="display: none;">
                    <strong>‚ö†Ô∏è Taking longer than expected?</strong><br>
                    The R environment is large (~50MB) and may take 1-3 minutes on slower connections.
                    <br><br>
                    <button class="btn btn-outline-primary btn-sm" onclick="showFallback()">
                        View Static Demo Instead
                    </button>
                </div>
            </div>

            <!-- Shinylive Container -->
            <div id="shinylive-container"></div>

            <!-- Fallback Static Demo -->
            <div class="fallback-app" id="fallback-app">
                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">üìä Static Demo Version</h4>
                    <p>The interactive R app is loading in the background. Here's a preview of what you'll see:</p>
                </div>
                
                <h3 style="color: #ea3a44; text-align: center; margin-bottom: 0px;">
                    Interactive Graph: Understanding the Correlation Coefficient
                </h3>
                <p style="text-align: center; color: #797979; margin-bottom: 15px; font-size: 18px;">
                    By Elena Llaudet, co-author of 
                    <a href="https://bit.ly/dss_textbook" target="_blank" style="color: #797979; text-decoration: none; font-style: italic;">Data Analysis for Social Science</a>
                    (DSS)
                </p>

                <div style="background-color: #f1f3f5; border-left: 4px solid #ea3a44; padding: 15px; margin-bottom: 15px;">
                    <p style="margin: 0 0 10px 0; font-size: 16px; color: #333333;">
                        The correlation coefficient captures the direction and strength of the linear association between two variables with a number that ranges from -1 to 1.
                    </p>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.4;">
                        <li style="margin-bottom: 8px; font-size: 16px; color: #333333;">
                            The sign reflects the direction: positive when variables move together, negative when they move in opposite directions.
                        </li>
                        <li style="margin-bottom: 0; font-size: 16px; color: #333333;">
                            The absolute value reflects strength: 0 (no association) to 1 (perfect association).
                        </li>
                    </ul>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <h5>Controls (Interactive Version):</h5>
                        <div class="mb-3">
                            <label class="form-label">Direction of Linear Association:</label>
                            <select class="form-select" disabled>
                                <option>positive linear association</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Strength of Linear Association:</label>
                            <select class="form-select" disabled>
                                <option>perfect linear association</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" disabled>
                                <label class="form-check-label">Show Line of Best Fit</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div style="background-color: #f8f9fa; border: 2px dashed #dee2e6; height: 400px; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                            <div style="text-align: center; color: #6c757d;">
                                <h5>üìà Interactive Scatterplot</h5>
                                <p>The full interactive graph will appear here<br>once the R environment loads.</p>
                                <p><strong>Correlation = 1.00</strong></p>
                                <small>Demo shows perfect positive correlation</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary" onclick="retryLoading()" id="retry-btn">
                        üîÑ Try Loading Interactive Version Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Analytics tracking functions
        function trackEvent(eventName, parameters = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
            console.log('Analytics Event:', eventName, parameters);
        }

        // Progress tracking
        let currentStep = 1;
        let loadingStartTime = Date.now();
        let timeoutWarningShown = false;
        let loadingTimeout;

        function updateProgress(step, message) {
            if (currentStep > 1) {
                const prevStep = document.getElementById(`step-${currentStep - 1}`);
                if (prevStep) {
                    prevStep.classList.remove('active');
                    prevStep.classList.add('completed');
                }
            }

            currentStep = step;
            const currentStepEl = document.getElementById(`step-${currentStep}`);
            if (currentStepEl) {
                currentStepEl.classList.add('active');
            }

            const progress = (step / 5) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = message;

            trackEvent('app_loading_progress', {
                step: step,
                total_steps: 5,
                progress_percent: Math.round(progress),
                elapsed_time: Date.now() - loadingStartTime
            });
        }

        function showTimeoutWarning() {
            if (!timeoutWarningShown) {
                document.getElementById('timeout-warning').style.display = 'block';
                timeoutWarningShown = true;
                trackEvent('loading_timeout_warning_shown', {
                    elapsed_time: Date.now() - loadingStartTime
                });
            }
        }

        function showFallback() {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('fallback-app').style.display = 'block';
            trackEvent('fallback_demo_shown', {
                reason: 'user_requested',
                elapsed_time: Date.now() - loadingStartTime
            });
        }

        function retryLoading() {
            document.getElementById('fallback-app').style.display = 'none';
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('timeout-warning').style.display = 'none';
            timeoutWarningShown = false;
            currentStep = 1;
            loadingStartTime = Date.now();
            
            // Reset progress
            updateProgress(1, 'Retrying initialization...');
            
            // Try loading again
            loadShinyliveApp();
            
            trackEvent('loading_retry_attempted');
        }

        function loadShinyliveApp() {
            // Clear any existing timeout
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }

            // Set up timeout warning
            setTimeout(showTimeoutWarning, 30000); // Show warning after 30 seconds
            
            // Set up automatic fallback after 2 minutes
            loadingTimeout = setTimeout(() => {
                trackEvent('loading_timeout_fallback', {
                    elapsed_time: Date.now() - loadingStartTime
                });
                showFallback();
            }, 120000);

            // Simulate realistic loading steps
            setTimeout(() => updateProgress(2, 'Loading R packages...'), 15000);
            setTimeout(() => updateProgress(3, 'Initializing Shiny environment...'), 30000);
            setTimeout(() => updateProgress(4, 'Preparing interface...'), 45000);

            // Try to load shinylive
            import('https://cdn.jsdelivr.net/npm/shinylive@0.2.3/dist/shinylive.js')
                .then(({ runApp }) => {
                    updateProgress(4, 'Starting interactive app...');
                    
                    const appFiles = {
                        "app.R": `library(shiny)

## Define UI
ui = fluidPage(
  tags$head(
    tags$style(HTML("
      .well {
        background-color: #f1f3f5 !important;
        border: none;
        box-shadow: none;
      }
    "))
  ),

  h3("Interactive Graph: Understanding the Correlation Coefficient",
     style = "color: #ea3a44; text-align: center; margin-bottom: 0px;"),
  p("By Elena Llaudet, co-author of ",
    a("Data Analysis for Social Science", href = "https://bit.ly/dss_textbook", target = "_blank", style = "color: #797979; text-decoration: none; font-style: italic;"),
    " (DSS)", style = "text-align: center; color: #797979; margin-bottom: 15px; font-size: 18px;"),

  div(style = "background-color: #f1f3f5; border-left: 4px solid #ea3a44; padding: 15px; margin-bottom: 15px;",
      p("The correlation coefficient captures the direction and strength of the linear association between two variables with a number that ranges from -1 to 1.",
        style = "margin: 0 0 10px 0; font-size: 16px; color: #333333;"),
      HTML("
      <ul style='margin: 0; padding-left: 20px; line-height: 1.4;'>
        <li style='margin-bottom: 8px; font-size: 16px; color: #333333;'>
          The sign reflects the direction: positive when variables move together, negative when they move in opposite directions.
        </li>
        <li style='margin-bottom: 0; font-size: 16px; color: #333333;'>
          The absolute value reflects strength: 0 (no association) to 1 (perfect association).
        </li>
      </ul>
    ")),

  sidebarLayout(
    sidebarPanel(
      selectInput("sign", "Direction:", 
                  choices = c("positive linear association", "negative linear association")),
      selectInput("strength", "Strength:", 
                  choices = c("perfect linear association", "strong linear association", 
                             "weak to moderate linear association", "no linear association (approximately)")),
      checkboxInput("line", "Show Line of Best Fit", FALSE)
    ),

    mainPanel(
      plotOutput("distPlot", height = "400px"),
      helpText("Interactive scatterplot showing correlation patterns.")
    )
  )
)

server = function(input, output) {
  set.seed(1234)
  base_x <- rnorm(1000, mean = 50, sd = 10)

  computed_data <- reactive({
    sign_mult <- ifelse(input$sign == "positive linear association", 1, -1)
    
    y_values <- switch(input$strength,
                       "no linear association (approximately)" = rnorm(1000, mean = 50, sd = 20),
                       "weak to moderate linear association" = base_x + rnorm(1000, mean = 50, sd = 16),
                       "strong linear association" = base_x + rnorm(1000, mean = 50, sd = 7),
                       "perfect linear association" = base_x)
    
    y_final <- sign_mult * y_values
    correlation <- cor(base_x, y_final)
    
    list(x = base_x, y = y_final, correlation = correlation)
  })

  output$distPlot <- renderPlot({
    data <- computed_data()
    
    plot(data$x, data$y, col = "#1f78b4", pch = 19, cex = 0.6,
         xlab = "", ylab = "", xaxt = "n", yaxt = "n")
    
    if (input$line) {
      abline(lm(data$y ~ data$x), col = "#ea3a44", lty = "dashed", lwd = 2)
    }
    
    title(paste("Correlation =", round(data$correlation, 2)))
  })
}

shinyApp(ui = ui, server = server)`
                    };

                    return runApp(appFiles, "shinylive-container", {
                        width: "100%",
                        height: "800px"
                    });
                })
                .then(() => {
                    clearTimeout(loadingTimeout);
                    updateProgress(5, 'Ready to explore correlations!');
                    
                    setTimeout(() => {
                        document.getElementById('loading-container').style.display = 'none';
                        trackEvent('app_load_completed', {
                            load_time: Date.now() - loadingStartTime
                        });
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Shinylive loading error:', error);
                    clearTimeout(loadingTimeout);
                    
                    trackEvent('app_load_error', {
                        error_message: error.message,
                        elapsed_time: Date.now() - loadingStartTime
                    });
                    
                    document.getElementById('loading-container').innerHTML = `
                        <div class="error-container">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">‚ö†Ô∏è Loading Failed</h4>
                                <p>The interactive R environment couldn't load. This might be due to:</p>
                                <ul>
                                    <li>Slow internet connection</li>
                                    <li>Browser compatibility issues</li>
                                    <li>Firewall blocking WebAssembly</li>
                                </ul>
                                <hr>
                                <button class="btn btn-primary" onclick="showFallback()">View Static Demo</button>
                                <button class="btn btn-outline-secondary ms-2" onclick="retryLoading()">Try Again</button>
                            </div>
                        </div>
                    `;
                });
        }

        // Start loading
        trackEvent('app_load_started');
        updateProgress(1, 'Downloading R WebAssembly runtime (~50MB)...');
        loadShinyliveApp();
    </script>
</body>
</html>
